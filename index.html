<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Игроки проекта</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #1e1e1e;
    color: #fff;
    padding: 20px;
}

h1 { text-align: center; }

.add-player {
    max-width: 400px;
    margin: 0 auto 20px;
    background: #2b2b2b;
    padding: 15px;
    border-radius: 10px;
}

.add-player input {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    border-radius: 5px;
    border: none;
}

.add-player button {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 5px;
    background: #4caf50;
    color: white;
    cursor: pointer;
}

.players {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center;
}

.profile {
    background: #2b2b2b;
    padding: 15px;
    border-radius: 10px;
    width: 280px;
    text-align: center;
}

.profile-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #ff4d4d;
}

.mute-btn {
    margin-top: 10px;
    padding: 7px 14px;
    border: none;
    border-radius: 5px;
    background: #ff4d4d;
    color: white;
    cursor: pointer;
}

.mute-btn:disabled {
    background: gray;
    cursor: not-allowed;
}

.ban-message {
    margin-top: 8px;
    padding: 8px;
    background: #ff3333;
    border-radius: 5px;
    display: none;
    font-size: 13px;
}

.timer {
    margin-top: 5px;
    font-size: 12px;
}
</style>
</head>
<body>

<h1>Игроки проекта</h1>

<div class="add-player">
    <input id="nickname" placeholder="Ник игрока">
    <input id="avatarUrl" placeholder="URL аватарки">
    <button id="addPlayerBtn">Добавить игрока</button>
</div>

<div class="players" id="players"></div>

<script>
/* SUPABASE */
const supabase = window.supabase.createClient(
    "https://bhkuhygxynltevnagwbs.supabase.co",
    "sb_publishable_gxHDoyOaiUnoyKaIOK9eWw_lcem_lmO"
);

const playersContainer = document.getElementById("players");
const addBtn = document.getElementById("addPlayerBtn");

/* КНОПКА */
addBtn.addEventListener("click", addPlayer);

/* ДОБАВЛЕНИЕ ИГРОКА */
async function addPlayer() {
    const nicknameInput = document.getElementById("nickname");
    const avatarInput = document.getElementById("avatarUrl");

    const name = nicknameInput.value.trim();
    const avatar = avatarInput.value.trim();

    if (!name || !avatar) {
        alert("Заполните все поля");
        return;
    }

    const { error } = await supabase.from("players").insert({
        id: Date.now(),
        name,
        avatar,
        mutes: 0,
        ban_end: null
    });

    if (error) {
        console.error(error);
        alert("Ошибка Supabase (проверь RLS)");
        return;
    }

    nicknameInput.value = "";
    avatarInput.value = "";

    loadPlayers();
}

/* ЗАГРУЗКА ИГРОКОВ */
async function loadPlayers() {
    const { data, error } = await supabase
        .from("players")
        .select("*")
        .order("id", { ascending: false });

    if (error) {
        console.error(error);
        return;
    }

    playersContainer.innerHTML = "";
    data.forEach(renderPlayer);
}

/* ОТРИСОВКА */
function renderPlayer(player) {
    const div = document.createElement("div");
    div.className = "profile";

    div.innerHTML = `
        <div class="profile-header">
            <img class="avatar" src="${player.avatar}">
            <h3>${player.name}</h3>
        </div>

        <button class="mute-btn">Выдать мут</button>

        <div>Муты: <span>${player.mutes}</span></div>

        <div class="ban-message">
            Вам выдался бан за неадекватное поведение.<br>
            Подумайте о своём поведении.
            <div class="timer"></div>
        </div>
    `;

    playersContainer.appendChild(div);

    const muteBtn = div.querySelector(".mute-btn");
    const banMessage = div.querySelector(".ban-message");
    const timer = div.querySelector(".timer");

    if (player.ban_end && player.ban_end > Date.now()) {
        muteBtn.disabled = true;
        banMessage.style.display = "block";
        startTimer(player, timer, muteBtn, banMessage);
    }

    muteBtn.onclick = async () => {
        const newMutes = player.mutes + 1;
        let banEnd = player.ban_end;

        if (newMutes % 3 === 0) {
            banEnd = Date.now() + 12 * 60 * 60 * 1000;
        }

        await supabase.from("players")
            .update({ mutes: newMutes, ban_end: banEnd })
            .eq("id", player.id);

        loadPlayers();
    };
}

/* ТАЙМЕР */
function startTimer(player, timer, button, message) {
    const interval = setInterval(() => {
        const left = player.ban_end - Date.now();

        if (left <= 0) {
            clearInterval(interval);
            button.disabled = false;
            message.style.display = "none";
            return;
        }

        const h = Math.floor(left / 3600000);
        const m = Math.floor((left % 3600000) / 60000);
        const s = Math.floor((left % 60000) / 1000);

        timer.textContent = `До конца бана: ${h}ч ${m}м ${s}с`;
    }, 1000);
}

loadPlayers();
</script>

</body>
</html>
